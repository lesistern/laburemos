<!DOCTYPE html>
<html lang="es" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Restablecer contrase√±a en LaburAR - Cre√° una nueva contrase√±a segura">
    <meta name="keywords" content="restablecer contrase√±a, nueva contrase√±a, freelancer, argentina">
    <title>Restablecer Contrase√±a - LaburAR | Plataforma de Freelancers Argentina</title>
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/Laburar/assets/css/auth.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/Laburar/assets/img/favicon.ico">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <!-- Header -->
            <div class="auth-header">
                <div class="auth-logo">LaburAR</div>
                <div class="auth-subtitle">Plataforma de Freelancers Argentina</div>
                <h1 class="auth-title">Restablecer Contrase√±a</h1>
            </div>
            
            <!-- Body -->
            <div class="auth-body">
                <!-- Token Validation Loading -->
                <div id="tokenValidation" style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                    <h3>Verificando enlace...</h3>
                    <p>Validando tu enlace de recuperaci√≥n de contrase√±a.</p>
                </div>
                
                <!-- Reset Password Form -->
                <div id="resetPasswordForm" style="display: none;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîë</div>
                        <h3>Crear nueva contrase√±a</h3>
                        <p>Ingres√° tu nueva contrase√±a. Asegurate de que sea segura.</p>
                    </div>
                    
                    <form class="auth-form" data-action="reset-password" id="passwordResetForm">
                        <input type="hidden" name="token" id="resetToken">
                        
                        <div class="form-group">
                            <label for="new_password" class="form-label required">Nueva Contrase√±a</label>
                            <div style="position: relative;">
                                <input 
                                    type="password" 
                                    id="new_password" 
                                    name="password" 
                                    class="form-input" 
                                    data-validate="password"
                                    placeholder="Nueva contrase√±a segura"
                                    required
                                    autocomplete="new-password"
                                >
                                <button 
                                    type="button" 
                                    class="password-toggle" 
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;"
                                >üëÅ</button>
                            </div>
                            
                            <!-- Password Strength Indicator -->
                            <div class="password-strength">
                                <div class="password-strength-bar">
                                    <div class="password-strength-fill"></div>
                                </div>
                                <div class="password-requirements">
                                    <div class="password-requirement">
                                        <span class="requirement-icon"></span>
                                        Al menos 8 caracteres
                                    </div>
                                    <div class="password-requirement">
                                        <span class="requirement-icon"></span>
                                        Una letra min√∫scula
                                    </div>
                                    <div class="password-requirement">
                                        <span class="requirement-icon"></span>
                                        Una letra may√∫scula
                                    </div>
                                    <div class="password-requirement">
                                        <span class="requirement-icon"></span>
                                        Un n√∫mero
                                    </div>
                                    <div class="password-requirement">
                                        <span class="requirement-icon"></span>
                                        Un s√≠mbolo especial
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm_password" class="form-label required">Confirmar Nueva Contrase√±a</label>
                            <input 
                                type="password" 
                                id="confirm_password" 
                                name="password_confirmation" 
                                class="form-input" 
                                placeholder="Confirm√° tu nueva contrase√±a"
                                required
                                autocomplete="new-password"
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-full">
                            Cambiar contrase√±a
                        </button>
                    </form>
                    
                    <div class="alert alert-info" style="margin-top: 1.5rem;">
                        <span>‚ÑπÔ∏è</span>
                        <span>Por seguridad, cerraremos todas tus sesiones activas despu√©s del cambio.</span>
                    </div>
                </div>
                
                <!-- Success State -->
                <div id="resetSuccess" style="display: none; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--success-green);">‚úÖ</div>
                    <h3>¬°Contrase√±a cambiada exitosamente!</h3>
                    <p>Tu contrase√±a ha sido actualizada. Por seguridad, hemos cerrado todas tus sesiones activas.</p>
                    
                    <div style="margin: 2rem 0;">
                        <a href="/Laburar/login.html" class="btn btn-primary btn-full">
                            Iniciar sesi√≥n con nueva contrase√±a
                        </a>
                    </div>
                    
                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                        <p>Ya pod√©s usar tu nueva contrase√±a para acceder a tu cuenta.</p>
                    </div>
                </div>
                
                <!-- Error State -->
                <div id="resetError" style="display: none; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--error-red);">‚ùå</div>
                    <h3>Error en el restablecimiento</h3>
                    <p id="resetErrorMessage">El enlace de recuperaci√≥n es inv√°lido o ha expirado.</p>
                    
                    <div style="margin: 2rem 0;">
                        <a href="/Laburar/login.html" class="btn btn-primary">
                            Volver al login
                        </a>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <a href="/Laburar/login.html#forgot-password" class="btn btn-secondary">
                            Solicitar nuevo enlace
                        </a>
                    </div>
                    
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 1.5rem;">
                        <p>Los enlaces de recuperaci√≥n expiran despu√©s de 1 hora por seguridad.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="/Laburar/assets/js/auth.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            const tokenValidation = document.getElementById('tokenValidation');
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            const resetSuccess = document.getElementById('resetSuccess');
            const resetError = document.getElementById('resetError');
            const resetErrorMessage = document.getElementById('resetErrorMessage');
            const resetTokenInput = document.getElementById('resetToken');
            
            if (!token) {
                showError('Token de recuperaci√≥n no encontrado en la URL');
                return;
            }
            
            // Set token in hidden input
            resetTokenInput.value = token;
            
            try {
                // Validate token first
                const response = await fetch('/Laburar/api/AuthController.php?action=validate-reset-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResetForm();
                } else {
                    showError(result.error || 'Token inv√°lido o expirado');
                }
            } catch (error) {
                console.error('Token validation error:', error);
                showError('Error de conexi√≥n. Por favor intent√° de nuevo.');
            }
            
            function showResetForm() {
                tokenValidation.style.display = 'none';
                resetSuccess.style.display = 'none';
                resetError.style.display = 'none';
                resetPasswordForm.style.display = 'block';
            }
            
            function showSuccess() {
                tokenValidation.style.display = 'none';
                resetPasswordForm.style.display = 'none';
                resetError.style.display = 'none';
                resetSuccess.style.display = 'block';
            }
            
            function showError(message) {
                tokenValidation.style.display = 'none';
                resetPasswordForm.style.display = 'none';
                resetSuccess.style.display = 'none';
                resetErrorMessage.textContent = message;
                resetError.style.display = 'block';
            }
            
            // Form submission
            document.getElementById('passwordResetForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const password = formData.get('password');
                const passwordConfirmation = formData.get('password_confirmation');
                
                // Validate password match
                if (password !== passwordConfirmation) {
                    window.authManager.showAlert('error', 'Las contrase√±as no coinciden');
                    return;
                }
                
                // Validate password strength
                const passwordValidation = window.authManager.validator.validatePassword(password);
                if (!passwordValidation.valid) {
                    window.authManager.showAlert('error', passwordValidation.message);
                    return;
                }
                
                // Show loading state
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Cambiando contrase√±a...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/Laburar/api/AuthController.php?action=reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            token: token,
                            password: password
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showSuccess();
                        
                        // Track successful password reset
                        if (typeof gtag !== 'undefined') {
                            gtag('event', 'password_reset_success', {
                                'event_category': 'authentication',
                                'event_label': 'password_reset_completed'
                            });
                        }
                    } else {
                        window.authManager.showAlert('error', result.error || 'Error al cambiar la contrase√±a');
                        
                        // Track password reset error
                        if (typeof gtag !== 'undefined') {
                            gtag('event', 'password_reset_failed', {
                                'event_category': 'authentication',
                                'event_label': result.error || 'unknown_error'
                            });
                        }
                    }
                } catch (error) {
                    console.error('Password reset error:', error);
                    window.authManager.showAlert('error', 'Error de conexi√≥n. Intent√° de nuevo.');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            // Password confirmation validation
            document.getElementById('confirm_password')?.addEventListener('input', function(e) {
                const password = document.getElementById('new_password').value;
                const confirmation = e.target.value;
                
                if (confirmation && password !== confirmation) {
                    window.authManager.updateFieldStatus(e.target, false, 'Las contrase√±as no coinciden');
                } else if (confirmation && password === confirmation) {
                    window.authManager.updateFieldStatus(e.target, true, 'Las contrase√±as coinciden');
                }
            });
        });
    </script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_TRACKING_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_TRACKING_ID');
    </script>
</body>
</html>